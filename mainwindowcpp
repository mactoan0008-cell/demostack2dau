#include "mainwindow.h"
#include "ui_mainwindow.h"
#include <QMessageBox>
#include <QHeaderView>
#include <QIcon>
#include <QMenu>
#include <QAction>
#include <QDate>
#include <QSize>
#include <QInputDialog>
#include <QDebug>
#include <QDir>

MainWindow::MainWindow(QWidget *parent)
    : QMainWindow(parent)
    , ui(new Ui::MainWindow)
{
    ui->setupUi(this);
    
    // --- CẤU HÌNH GIAO DIỆN CHUNG CHO SÁCH & THỐNG KÊ ---
    ui->btnCapNhat->setIconSize(QSize(32, 32));
    ui->btnTaoMoiSach->setIconSize(QSize(32, 32));
    ui->btnKetThuc->setIconSize(QSize(32, 32));

    ui->tableDauSach->horizontalHeader()->setSectionResizeMode(QHeaderView::Stretch);
    ui->tableQuaHan->horizontalHeader()->setSectionResizeMode(QHeaderView::Stretch);
    ui->tableTop10->horizontalHeader()->setSectionResizeMode(QHeaderView::Stretch);
    
    m_selectedISBN = "";
    ui->lineSoLuong->setValidator(new QIntValidator(0, 9999, this));

    // --- CẤU HÌNH CÂY THỂ LOẠI (Module Sách) ---
    ui->treeLoaiSach->header()->hide();
    
    QIcon iconHaiKich(":/icons/hai-kich.png");
    QIcon iconVanHoc(":/icons/van-hoc.png");
    // ... (Các icon khác) ...

    // Tạo các Node thể loại
    QTreeWidgetItem* categoryHai = new QTreeWidgetItem(ui->treeLoaiSach);
    categoryHai->setText(0, "Hài kịch");
    categoryHai->setIcon(0, iconHaiKich);

    QTreeWidgetItem* categoryVanHoc = new QTreeWidgetItem(ui->treeLoaiSach);
    categoryVanHoc->setText(0, "Văn học");
    categoryVanHoc->setIcon(0, iconVanHoc);
    
    // ... (Tạo các node thể loại khác: Tâm lý, Toán, Tin, Truyện tranh...) ...

    QTreeWidgetItem* TatCaTheLoai = new QTreeWidgetItem(ui->treeLoaiSach);
    TatCaTheLoai->setText(0, "All");

    // Thêm sách con mẫu vào cây (chỉ để hiển thị UI)
    categoryHai->addChild(new QTreeWidgetItem(QStringList() << "Dế Mèn Phiêu Lưu Ký"));
    categoryTinHoc->addChild(new QTreeWidgetItem(QStringList() << "Cấu trúc dữ liệu và Giải thuật"));
    // ... (Thêm các sách mẫu khác) ...

    // --- KHỞI TẠO LOGIC ---
    m_logic = new ThuVienLogic(this);
    m_logic->KhoiTaoVaTaiDuLieu();

    connect(m_logic, &ThuVienLogic::guiThongBao, this, &MainWindow::hienThiThongBao);

    // --- KẾT NỐI TÍN HIỆU CHO MODULE SÁCH ---
    connect(m_logic, &ThuVienLogic::duLieuDauSachThayDoi,
            this, &MainWindow::capNhatBangDauSach);

    connect(ui->tableDauSach, &QTableWidget::cellClicked,
            this, &MainWindow::on_tableDauSach_cellClicked);

    connect(ui->treeLoaiSach, &QTreeWidget::itemClicked,
            this, &MainWindow::on_treeLoaiSach_itemClicked);

    connect(ui->tableDauSach, &QTableWidget::cellDoubleClicked,
            this, &MainWindow::on_tableDauSach_cellDoubleClicked);

    // Cập nhật bảng lần đầu
    capNhatBangDauSach();
    
    XoaTrangFormSach();
}

MainWindow::~MainWindow(){
    m_logic->LuuDuLieuKhiThoat();
    delete ui;
}

// =================================================================
// ===           MODULE 1: QUẢN LÝ SÁCH (ĐẦU SÁCH & KHO)         ===
// =================================================================

void MainWindow::on_btnTaoMoiSach_clicked(){
    XoaTrangFormSach();
    capNhatBangDauSach();
}

void MainWindow::on_btnKetThuc_clicked(){
    close();
}

void MainWindow::on_btnXoaDauSach_clicked()
{
    if (m_selectedISBN.isEmpty()) {
        QMessageBox::warning(this, "Chưa chọn sách", "Vui lòng chọn một đầu sách trên bảng để xóa!");
        return;
    }

    QMessageBox::StandardButton reply;
    reply = QMessageBox::question(this, "Cảnh báo xóa",
                                  "Bạn có chắc chắn muốn xóa đầu sách này?\n"
                                  "Hành động này sẽ XÓA TẤT CẢ các cuốn sách con trong kho (nếu chưa ai mượn).",
                                  QMessageBox::Yes | QMessageBox::No);

    if (reply == QMessageBox::No) return;

    int ketQua = m_logic->XoaDauSach(m_selectedISBN.toStdString());

    if (ketQua == 1) {
        QMessageBox::information(this, "Thành công", "Đã xóa đầu sách và toàn bộ sách con trong kho.");
        m_selectedISBN = "";
        XoaTrangFormSach();
    }
    else if (ketQua == -1) {
        QMessageBox::critical(this, "Không thể xóa", "Đầu sách này đang có độc giả mượn!...");
    }
    else if (ketQua == 0) {
        QMessageBox::warning(this, "Lỗi", "Không tìm thấy đầu sách trong hệ thống.");
    }
}

void MainWindow::XoaTrangFormSach(){
    ui->lineISBN->clear();
    ui->lineTenSach->clear();
    ui->lineTacGia->clear();
    ui->lineTheLoai->clear();
    ui->lineSoTrang->clear();
    ui->lineNamXB->clear();
    ui->lineSoLuong ->setText("0");

    ui->lineISBN->setReadOnly(false);
    m_selectedISBN = "";
    ui->tableDauSach->clearSelection();
}

void MainWindow::on_btnCapNhat_clicked(){
    // 1. Lấy dữ liệu
    QString isbn = ui->lineISBN->text().trimmed();
    QString tenSach = ui->lineTenSach->text().trimmed();
    QString tacGia = ui->lineTacGia->text().trimmed();
    QString theLoai = ui->lineTheLoai->text().trimmed();
    int soTrang = ui->lineSoTrang->text().toInt();
    int namXB = ui->lineNamXB->text().toInt();
    int soLuongConMoi = ui->lineSoLuong->text().toInt();

    if (namXB <= 0) namXB = 2000;

    if (isbn.isEmpty() || tenSach.isEmpty() || tacGia.isEmpty()) {
        hienThiThongBao("ISBN, Tên Sách, Tác Giả không được để trống!");
        return;
    }

    // --- TRƯỜNG HỢP 1: THÊM MỚI ---
    if (m_selectedISBN.isEmpty())
    {
        bool themThanhCong = m_logic->ThemDauSach(isbn.toStdString(), tenSach.toStdString(),
                                                  tacGia.toStdString(), theLoai.toStdString(),
                                                  soTrang, namXB);

        if (themThanhCong && soLuongConMoi > 0) {
            string dsMaSachTao;
            m_logic->ThemSachCon(isbn.toStdString(), soLuongConMoi, dsMaSachTao);
        }
    }
    // --- TRƯỜNG HỢP 2: CẬP NHẬT / SỬA ---
    else
    {
        m_logic->HieuChinhDauSach(isbn.toStdString(), tenSach.toStdString(),
                                  tacGia.toStdString(), theLoai.toStdString(),
                                  soTrang, namXB);

        // Xử lý số lượng (Tăng hoặc Giảm)
        DauSach* ds = m_logic->TimDauSachTheoISBN(isbn.toStdString());
        int soLuongHienTai = m_logic->DemSoSachCon(ds);
        int chenhLech = soLuongConMoi - soLuongHienTai;

        if (chenhLech > 0) {
            string dsMaSachTao;
            m_logic->ThemSachCon(isbn.toStdString(), chenhLech, dsMaSachTao);
            QMessageBox::information(this, "Cập nhật", "Đã nhập thêm " + QString::number(chenhLech) + " cuốn sách mới.");
        }
        else if (chenhLech < 0) {
            int soLuongCanGiam = abs(chenhLech);
            QMessageBox::StandardButton reply = QMessageBox::question(this, "Cảnh báo xóa sách",
                                                                      "Bạn đang giảm số lượng từ " + QString::number(soLuongHienTai) + " xuống " + QString::number(soLuongConMoi) + ".\n"
                                                                      "Hệ thống sẽ xóa ngẫu nhiên " + QString::number(soLuongCanGiam) + " cuốn sách ĐANG TRONG KHO.\nBạn có chắc chắn không?",
                                                                      QMessageBox::Yes|QMessageBox::No);

            if (reply == QMessageBox::Yes) {
                int daXoa = m_logic->XoaBotSachTrongKho(isbn.toStdString(), soLuongCanGiam);
                if (daXoa < soLuongCanGiam) {
                    QMessageBox::warning(this, "Kết quả", "Chỉ xóa được " + QString::number(daXoa) + " cuốn. Còn lại đang có người mượn.");
                } else {
                    QMessageBox::information(this, "Thành công", "Đã giảm số lượng sách thành công.");
                }
            }
        }
    }
    XoaTrangFormSach();
    capNhatBangDauSach();
}

void MainWindow::capNhatBangDauSach(){
    DauSach* mangDauSach[MAX_DAUSACH];
    int soLuong = 0;
    
    // Lấy danh sách (tham số false: chưa sắp xếp theo thể loại ở bước này nếu muốn, 
    // hoặc tùy logic của bạn đã cài trong LayDanhSachDauSach)
    m_logic->LayDanhSachDauSach(mangDauSach, soLuong, false);

    ui->tableDauSach->setRowCount(0);
    if (ui->tableDauSach->columnCount() < 7) {
        ui->tableDauSach->setColumnCount(7);
        ui->tableDauSach->setHorizontalHeaderLabels({"ISBN","Tên Sách","Thể Loại","Tác Giả", "Số trang", "Năm xuất bản ","Số lượng"});
    }

    int hangHienTai = 0;
    for (int i = 0; i < soLuong; i++) {
        // Lọc theo thể loại nếu người dùng click cây thư mục
        if (!m_selectedTheLoai.isEmpty())
        {
            QString theLoaiSach = QString::fromStdString(mangDauSach[i]->theloai).toLower();
            QString theLoaiDangChon = m_selectedTheLoai.toLower();
            if (theLoaiSach != theLoaiDangChon) continue;
        }

        ui->tableDauSach->insertRow(hangHienTai);
        ui->tableDauSach->setItem(hangHienTai, 0, new QTableWidgetItem(QString::fromStdString(mangDauSach[i]->ISBN)));
        ui->tableDauSach->setItem(hangHienTai, 1, new QTableWidgetItem(QString::fromStdString(mangDauSach[i]->tensach)));
        ui->tableDauSach->setItem(hangHienTai, 2, new QTableWidgetItem(QString::fromStdString(mangDauSach[i]->theloai)));
        ui->tableDauSach->setItem(hangHienTai, 3, new QTableWidgetItem(QString::fromStdString(mangDauSach[i]->tacgia)));
        ui->tableDauSach->setItem(hangHienTai, 4, new QTableWidgetItem(QString::number(mangDauSach[i]->sotrang)));
        ui->tableDauSach->setItem(hangHienTai, 5, new QTableWidgetItem(QString::number(mangDauSach[i]->namxb)));

        int soLuongCon = m_logic->DemSoSachCon(mangDauSach[i]);
        ui->tableDauSach->setItem(hangHienTai, 6, new QTableWidgetItem(QString::number(soLuongCon)));

        hangHienTai++;
    }
}

void MainWindow::on_tableDauSach_cellClicked(int row, int column){
    m_selectedISBN = ui->tableDauSach->item(row, 0)->text();

    ui->lineISBN->setText(m_selectedISBN);
    ui->lineTenSach ->setText(ui->tableDauSach->item(row, 1)->text());
    ui->lineTheLoai->setText(ui->tableDauSach->item(row, 2)->text());
    ui->lineTacGia->setText(ui->tableDauSach->item(row, 3)->text());
    ui->lineSoTrang->setText(ui->tableDauSach->item(row, 4)->text());
    ui->lineNamXB->setText(ui->tableDauSach->item(row, 5)->text());
    ui->lineSoLuong->setText(ui->tableDauSach->item(row, 6)->text());

    ui->lineISBN->setReadOnly(true);
}

void MainWindow::on_btnTimKiem_clicked(){
    QString tuKhoaISBN = ui->lineISBN->text().trimmed();
    QString tuKhoaTen  = ui->lineTenSach->text().trimmed();
    DauSach* ketQua[MAX_DAUSACH];
    int soLuongKQ = 0;

    // ƯU TIÊN 1: Tìm ISBN
    if (!tuKhoaISBN.isEmpty()) {
        DauSach* ds = m_logic->TimDauSachTheoISBN(tuKhoaISBN.toStdString());
        if (ds != NULL) {
            ketQua[0] = ds; soLuongKQ = 1;
        } else {
            hienThiThongBao("Không tìm thấy đầu sách có ISBN: " + tuKhoaISBN);
            return;
        }
    }
    // ƯU TIÊN 2: Tìm Tên Sách
    else if (!tuKhoaTen.isEmpty()) {
        m_logic->TimSachTheoTen(tuKhoaTen.toStdString(), ketQua, soLuongKQ);
        if (soLuongKQ == 0) {
            hienThiThongBao("Không tìm thấy sách nào có tên chứa: " + tuKhoaTen);
            return;
        }
    }
    else {
        m_selectedTheLoai = "";
        capNhatBangDauSach();
        return;
    }

    // Hiển thị kết quả tìm kiếm
    ui->tableDauSach->setRowCount(0);
    for (int i = 0; i < soLuongKQ; i++) {
        DauSach* ds = ketQua[i];
        ui->tableDauSach->insertRow(i);
        ui->tableDauSach->setItem(i, 0, new QTableWidgetItem(QString::fromStdString(ds->ISBN)));
        ui->tableDauSach->setItem(i, 1, new QTableWidgetItem(QString::fromStdString(ds->tensach)));
        // ... (điền các cột còn lại tương tự capNhatBangDauSach) ...
        ui->tableDauSach->setItem(i, 2, new QTableWidgetItem(QString::fromStdString(ds->theloai)));
        ui->tableDauSach->setItem(i, 3, new QTableWidgetItem(QString::fromStdString(ds->tacgia)));
        ui->tableDauSach->setItem(i, 4, new QTableWidgetItem(QString::number(ds->namxb)));
        ui->tableDauSach->setItem(i, 5, new QTableWidgetItem(QString::number(ds->sotrang)));
        int soLuongCon = m_logic->DemSoSachCon(ds);
        ui->tableDauSach->setItem(i, 6 , new QTableWidgetItem(QString::number(soLuongCon)));
    }
}

void MainWindow::on_treeLoaiSach_itemClicked(QTreeWidgetItem *item, int column){
    if (item->parent() != NULL) return; // Chỉ xử lý click vào mục cha

    XoaTrangFormSach();
    QString theLoai = item->text(0);
    
    if (theLoai == "All") {
        m_selectedTheLoai = "";
    } else {
        m_selectedTheLoai = theLoai;
        ui->lineTheLoai->setText(theLoai);
    }
    capNhatBangDauSach();
}

void MainWindow::on_tableDauSach_cellDoubleClicked(int row, int column){
    if (row < 0) return;
    QString isbn = ui->tableDauSach->item(row, 0)->text();
    DauSach* dauSachDuocChon = m_logic->TimDauSachTheoISBN(isbn.toStdString());
    if (dauSachDuocChon == NULL) return;

    int soLuongSachCon = m_logic->DemSoSachCon(dauSachDuocChon);
    nodeSach* pHead = dauSachDuocChon->firstDMS;

    QDialog *dialog = new QDialog(this);
    dialog->setWindowTitle("Chi tiết sách: " + QString::fromStdString(dauSachDuocChon->tensach));
    dialog->resize(800, 450);

    QTableWidget *table = new QTableWidget(dialog);
    table->setColumnCount(4);
    table->setHorizontalHeaderLabels(QStringList() << "Mã Sách" << "Trạng thái" << "Vị trí" << "Người đang mượn");
    table->setRowCount(soLuongSachCon);

    nodeSach* pCurrent = pHead;
    int hangHienTai = 0;
    while (pCurrent != NULL && hangHienTai < soLuongSachCon)
    {
        Sach &sach = pCurrent->sach;
        table->setItem(hangHienTai, 0, new QTableWidgetItem(QString::fromStdString(sach.MASACH)));
        
        string ttChu = m_logic->ChuyenTrangThaiThanhChu(sach.trangthai);
        table->setItem(hangHienTai, 1, new QTableWidgetItem(QString::fromStdString(ttChu)));
        table->setItem(hangHienTai, 2, new QTableWidgetItem(QString::fromStdString(sach.vitri)));

        // Tìm người mượn (để hiển thị tên)
        QString nguoiMuon = "-";
        if (sach.trangthai == 1) { // Đang mượn
            treeDG dg = m_logic->TimDocGiaDangMuonSach(sach.MASACH);
            if (dg != NULL) {
                nguoiMuon = QString::fromStdString(dg->dg.Ho + " " + dg->dg.Ten) + " (" + QString::number(dg->dg.MATHE) + ")";
            }
        }
        QTableWidgetItem* itemNguoiMuon = new QTableWidgetItem(nguoiMuon);
        if (sach.trangthai == 1) itemNguoiMuon->setForeground(Qt::red);
        table->setItem(hangHienTai, 3, itemNguoiMuon);

        pCurrent = pCurrent->next;
        hangHienTai++;
    }

    // Context Menu (Thanh lý, Sửa vị trí)
    table->setContextMenuPolicy(Qt::CustomContextMenu);
    connect(table, &QTableWidget::customContextMenuRequested, [=](const QPoint &pos){
        QTableWidgetItem *item = table->itemAt(pos);
        if (!item) return;
        int currentRow = item->row();
        QString maSach = table->item(currentRow, 0)->text();
        QString trangThaiHienTai = table->item(currentRow, 1)->text();
        QString viTriHienTai = table->item(currentRow, 2)->text();

        QMenu menu;
        QAction *actThanhLy = menu.addAction("Thanh lý cuốn này");
        if (trangThaiHienTai != QString::fromUtf8("Cho mượn được")) actThanhLy->setEnabled(false);

        QAction *actSuaViTri = menu.addAction("Cập nhật vị trí");

        connect(actThanhLy, &QAction::triggered, [=](){
            // ... (Logic xác nhận thanh lý) ...
             if (m_logic->ThanhLySach(isbn.toStdString(), maSach.toStdString())) {
                table->item(currentRow, 1)->setText(QString::fromUtf8("Đã thanh lý"));
             }
        });
        
        connect(actSuaViTri, &QAction::triggered, [=](){
             // ... (Logic sửa vị trí) ...
             // Gọi m_logic->CapNhatViTriSach(...)
        });
        menu.exec(table->mapToGlobal(pos));
    });

    QVBoxLayout *layout = new QVBoxLayout(dialog);
    layout->addWidget(table);
    dialog->setLayout(layout);
    dialog->exec();
    delete dialog;
}

// =================================================================
// ===           MODULE 2: THỐNG KÊ (QUÁ HẠN & TOP 10)           ===
// =================================================================

void MainWindow::on_btnThongKeQuaHan_clicked(){
    DocGiaQuaHan danhSachQH[MAX_DAUSACH];
    int soLuong = 0;
    QDate qDate = ui->dateMocThoiGian->date();

    Date ngayMoc;
    ngayMoc.d = qDate.day();
    ngayMoc.m = qDate.month();
    ngayMoc.y = qDate.year();

    m_logic->LayDanhSachQuaHan(danhSachQH, soLuong, ngayMoc);

    ui->tableQuaHan->setRowCount(0);
    if (ui->tableQuaHan->columnCount() < 4){
        ui->tableQuaHan->setColumnCount(4);
        ui->tableQuaHan->setHorizontalHeaderLabels({"Mã ĐG", "Họ Tên", "Trạng Thái Thẻ", "Số Ngày Quá Hạn (Max)"});
    }

    if (soLuong == 0){
        QMessageBox::information(this, "Thông báo", "Tuyệt vời! Không có độc giả nào vi phạm.");
        return;
    }

    for (int i = 0; i < soLuong; i++){
        ui->tableQuaHan->insertRow(i);
        ui->tableQuaHan->setItem(i, 0, new QTableWidgetItem(QString::number(danhSachQH[i].dg->MATHE)));
        QString hoTen = QString::fromStdString(danhSachQH[i].dg->Ho + " " + danhSachQH[i].dg->Ten);
        ui->tableQuaHan->setItem(i, 1, new QTableWidgetItem(hoTen));
        
        QString trangThai = (danhSachQH[i].dg->trangthai == THE_KHOA) ? "Đã Bị Khóa" : "Đang Hoạt Động";
        QTableWidgetItem* itemStatus = new QTableWidgetItem(trangThai);
        if (danhSachQH[i].dg->trangthai == THE_KHOA) itemStatus->setForeground(Qt::red);
        ui->tableQuaHan->setItem(i, 2, itemStatus);

        QTableWidgetItem* itemNgay = new QTableWidgetItem(QString::number(danhSachQH[i].soNgayMax) + " ngày");
        itemNgay->setForeground(Qt::red);
        itemNgay->setFont(QFont("Arial", 10, QFont::Bold));
        ui->tableQuaHan->setItem(i, 3, itemNgay);
    }
}

void MainWindow::on_btnTop10Sach_clicked(){
    DauSach* top10[10];
    int soLuong = 0;
    m_logic->LayTop10SachMuonNhieuNhat(top10, soLuong);

    ui->tableTop10->setRowCount(0);
    if (ui->tableTop10->columnCount() < 4) {
        ui->tableTop10->setColumnCount(4);
        ui->tableTop10->setHorizontalHeaderLabels({"ISBN", "Tên Sách", "Tác Giả", "Lượt Mượn"});
    }

    if (soLuong == 0){
        QMessageBox::information(this, "Thông báo", "Thư viện chưa có dữ liệu mượn nào.");
        return;
    }

    for (int i = 0; i < soLuong; i++){
        ui->tableTop10->insertRow(i);
        ui->tableTop10->setItem(i, 0, new QTableWidgetItem(QString::fromStdString(top10[i]->ISBN)));
        ui->tableTop10->setItem(i, 1, new QTableWidgetItem(QString::fromStdString(top10[i]->tensach)));
        ui->tableTop10->setItem(i, 2, new QTableWidgetItem(QString::fromStdString(top10[i]->tacgia)));

        QTableWidgetItem* itemLuotMuon = new QTableWidgetItem(QString::number(top10[i]->luotmuon));
        itemLuotMuon->setForeground(Qt::blue);
        itemLuotMuon->setFont(QFont("Arial", 11, QFont::Bold));
        itemLuotMuon->setTextAlignment(Qt::AlignCenter);
        ui->tableTop10->setItem(i, 3, itemLuotMuon);
    }
}

void MainWindow::hienThiThongBao(QString message){
    QMessageBox::information(this, "Thong Bao", message);
}

